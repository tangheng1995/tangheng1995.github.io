I"…Ô<ul id="markdown-toc">
  <li><a href="#ä»‹ç»" id="markdown-toc-ä»‹ç»">ä»‹ç»</a></li>
  <li><a href="#goroutineåŸç†" id="markdown-toc-goroutineåŸç†">goroutineåŸç†</a>    <ul>
      <li><a href="#goroutineç®€ä»‹" id="markdown-toc-goroutineç®€ä»‹">goroutineç®€ä»‹</a></li>
      <li><a href="#goroutineå†…éƒ¨åŸç†" id="markdown-toc-goroutineå†…éƒ¨åŸç†">goroutineå†…éƒ¨åŸç†</a>        <ul>
          <li><a href="#å¹¶å‘" id="markdown-toc-å¹¶å‘">å¹¶å‘</a></li>
          <li><a href="#å¹¶è¡Œ" id="markdown-toc-å¹¶è¡Œ">å¹¶è¡Œ</a></li>
          <li><a href="#è¿›ç¨‹" id="markdown-toc-è¿›ç¨‹">è¿›ç¨‹</a></li>
          <li><a href="#çº¿ç¨‹" id="markdown-toc-çº¿ç¨‹">çº¿ç¨‹</a></li>
          <li><a href="#åç¨‹" id="markdown-toc-åç¨‹">åç¨‹</a></li>
          <li><a href="#è°ƒåº¦æ¨¡å‹ç®€ä»‹" id="markdown-toc-è°ƒåº¦æ¨¡å‹ç®€ä»‹">è°ƒåº¦æ¨¡å‹ç®€ä»‹</a></li>
          <li><a href="#è°ƒåº¦å®ç°" id="markdown-toc-è°ƒåº¦å®ç°">è°ƒåº¦å®ç°</a></li>
        </ul>
      </li>
      <li><a href="#ä½¿ç”¨goroutine" id="markdown-toc-ä½¿ç”¨goroutine">ä½¿ç”¨goroutine</a>        <ul>
          <li><a href="#åŸºæœ¬ä½¿ç”¨" id="markdown-toc-åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a></li>
          <li><a href="#goroutineå¼‚å¸¸æ•æ‰" id="markdown-toc-goroutineå¼‚å¸¸æ•æ‰">goroutineå¼‚å¸¸æ•æ‰</a></li>
          <li><a href="#åŒæ­¥çš„goroutine" id="markdown-toc-åŒæ­¥çš„goroutine">åŒæ­¥çš„goroutine</a></li>
          <li><a href="#goroutineä¹‹é—´çš„é€šè®¯" id="markdown-toc-goroutineä¹‹é—´çš„é€šè®¯">goroutineä¹‹é—´çš„é€šè®¯</a></li>
        </ul>
      </li>
      <li><a href="#channel" id="markdown-toc-channel">channel</a>        <ul>
          <li><a href="#ç®€ä»‹" id="markdown-toc-ç®€ä»‹">ç®€ä»‹</a></li>
          <li><a href="#channelä½¿ç”¨" id="markdown-toc-channelä½¿ç”¨">channelä½¿ç”¨</a></li>
          <li><a href="#å¸¦ç¼“å†²åŒºchanneå’Œä¸å¸¦ç¼“å†²åŒºchannel" id="markdown-toc-å¸¦ç¼“å†²åŒºchanneå’Œä¸å¸¦ç¼“å†²åŒºchannel">å¸¦ç¼“å†²åŒºchanneå’Œä¸å¸¦ç¼“å†²åŒºchannel</a></li>
          <li><a href="#channelå®ç°ä½œä¸šæ± " id="markdown-toc-channelå®ç°ä½œä¸šæ± ">channelå®ç°ä½œä¸šæ± </a></li>
          <li><a href="#åªè¯»channelå’Œåªå†™channel" id="markdown-toc-åªè¯»channelå’Œåªå†™channel">åªè¯»channelå’Œåªå†™channel</a></li>
          <li><a href="#select-caseå®ç°éé˜»å¡channel" id="markdown-toc-select-caseå®ç°éé˜»å¡channel">select-caseå®ç°éé˜»å¡channel</a></li>
          <li><a href="#channelé¢‘ç‡æ§åˆ¶" id="markdown-toc-channelé¢‘ç‡æ§åˆ¶">channelé¢‘ç‡æ§åˆ¶</a></li>
        </ul>
      </li>
      <li><a href="#å¼•ç”¨" id="markdown-toc-å¼•ç”¨">å¼•ç”¨</a></li>
    </ul>
  </li>
</ul>

<h2 id="ä»‹ç»">ä»‹ç»</h2>

<p>Golang goroutine åŸç†ã€‚</p>

<h2 id="goroutineåŸç†">goroutineåŸç†</h2>

<blockquote>
  <p><a href="https://juejin.im/entry/5b3f2f166fb9a04fb900b119">è½¬è½½ï¼šæ˜é‡‘</a></p>
</blockquote>

<h3 id="goroutineç®€ä»‹">goroutineç®€ä»‹</h3>

<p>goroutineæ˜¯goè¯­è¨€ä¸­æœ€ä¸ºNBçš„è®¾è®¡ï¼Œä¹Ÿæ˜¯å…¶é­…åŠ›æ‰€åœ¨ï¼Œgoroutineçš„æœ¬è´¨æ˜¯åç¨‹ï¼Œæ˜¯å®ç°å¹¶è¡Œè®¡ç®—çš„æ ¸å¿ƒã€‚goroutineä½¿ç”¨æ–¹å¼éå¸¸çš„ç®€å•ï¼Œåªéœ€ä½¿ç”¨goå…³é”®å­—å³å¯å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”å®ƒæ˜¯å¤„äºå¼‚æ­¥æ–¹å¼è¿è¡Œï¼Œä½ ä¸éœ€è¦ç­‰å®ƒè¿è¡Œå®Œæˆä»¥ååœ¨æ‰§è¡Œä»¥åçš„ä»£ç ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">go</span> <span class="k">func</span><span class="p">()</span><span class="c">//é€šè¿‡goå…³é”®å­—å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥è¿è¡Œå‡½æ•°</span>
</code></pre></div></div>

<h3 id="goroutineå†…éƒ¨åŸç†">goroutineå†…éƒ¨åŸç†</h3>

<p>æ¦‚å¿µä»‹ç»
åœ¨è¿›è¡Œå®ç°åŸç†ä¹‹å‰ï¼Œäº†è§£ä¸‹ä¸€äº›å…³é”®æ€§æœ¯è¯­çš„æ¦‚å¿µã€‚</p>

<h4 id="å¹¶å‘">å¹¶å‘</h4>

<p>ä¸€ä¸ªcpuä¸Šèƒ½åŒæ—¶æ‰§è¡Œå¤šé¡¹ä»»åŠ¡ï¼Œåœ¨å¾ˆçŸ­æ—¶é—´å†…ï¼Œcpuæ¥å›åˆ‡æ¢ä»»åŠ¡æ‰§è¡Œ(åœ¨æŸæ®µå¾ˆçŸ­æ—¶é—´å†…æ‰§è¡Œç¨‹åºaï¼Œç„¶ååˆè¿…é€Ÿå¾—åˆ‡æ¢åˆ°ç¨‹åºbå»æ‰§è¡Œ)ï¼Œæœ‰æ—¶é—´ä¸Šçš„é‡å ï¼ˆå®è§‚ä¸Šæ˜¯åŒæ—¶çš„ï¼Œå¾®è§‚ä»æ˜¯é¡ºåºæ‰§è¡Œï¼‰,è¿™æ ·çœ‹èµ·æ¥å¤šä¸ªä»»åŠ¡åƒæ˜¯åŒæ—¶æ‰§è¡Œï¼Œè¿™å°±æ˜¯å¹¶å‘ã€‚</p>

<h4 id="å¹¶è¡Œ">å¹¶è¡Œ</h4>

<p>å½“ç³»ç»Ÿæœ‰å¤šä¸ªCPUæ—¶,æ¯ä¸ªCPUåŒä¸€æ—¶åˆ»éƒ½è¿è¡Œä»»åŠ¡ï¼Œäº’ä¸æŠ¢å è‡ªå·±æ‰€åœ¨çš„CPUèµ„æºï¼ŒåŒæ—¶è¿›è¡Œï¼Œç§°ä¸ºå¹¶è¡Œã€‚</p>

<h4 id="è¿›ç¨‹">è¿›ç¨‹</h4>

<p>cpuåœ¨åˆ‡æ¢ç¨‹åºçš„æ—¶å€™ï¼Œå¦‚æœä¸ä¿å­˜ä¸Šä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„contextâ€“ä¸Šä¸‹æ–‡ï¼‰ï¼Œç›´æ¥åˆ‡æ¢ä¸‹ä¸€ä¸ªç¨‹åºï¼Œå°±ä¼šä¸¢å¤±ä¸Šä¸€ä¸ªç¨‹åºçš„ä¸€ç³»åˆ—çŠ¶æ€ï¼Œäºæ˜¯å¼•å…¥äº†è¿›ç¨‹è¿™ä¸ªæ¦‚å¿µï¼Œç”¨ä»¥åˆ’åˆ†å¥½ç¨‹åºè¿è¡Œæ—¶æ‰€éœ€è¦çš„èµ„æºã€‚å› æ­¤è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªç¨‹åºè¿è¡Œæ—¶å€™çš„æ‰€éœ€è¦çš„åŸºæœ¬èµ„æºå•ä½ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯ç¨‹åºè¿è¡Œçš„ä¸€ä¸ªå®ä½“ï¼‰ã€‚</p>

<h4 id="çº¿ç¨‹">çº¿ç¨‹</h4>

<p>cpuåˆ‡æ¢å¤šä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šèŠ±è´¹ä¸å°‘çš„æ—¶é—´ï¼Œå› ä¸ºåˆ‡æ¢è¿›ç¨‹éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œè€Œæ¯æ¬¡è°ƒåº¦éœ€è¦å†…æ ¸æ€éƒ½éœ€è¦è¯»å–ç”¨æˆ·æ€çš„æ•°æ®ï¼Œè¿›ç¨‹ä¸€æ—¦å¤šèµ·æ¥ï¼Œcpuè°ƒåº¦ä¼šæ¶ˆè€—ä¸€å¤§å †èµ„æºï¼Œå› æ­¤å¼•å…¥äº†çº¿ç¨‹çš„æ¦‚å¿µï¼Œçº¿ç¨‹æœ¬èº«å‡ ä¹ä¸å æœ‰èµ„æºï¼Œä»–ä»¬å…±äº«è¿›ç¨‹é‡Œçš„èµ„æºï¼Œå†…æ ¸è°ƒåº¦èµ·æ¥ä¸ä¼šé‚£ä¹ˆåƒè¿›ç¨‹åˆ‡æ¢é‚£ä¹ˆè€—è´¹èµ„æºã€‚</p>

<h4 id="åç¨‹">åç¨‹</h4>

<p>åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚å› æ­¤ï¼Œåç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼ˆå³æ‰€æœ‰å±€éƒ¨çŠ¶æ€çš„ä¸€ä¸ªç‰¹å®šç»„åˆï¼‰ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ï¼Œæ¢ç§è¯´æ³•ï¼šè¿›å…¥ä¸Šä¸€æ¬¡ç¦»å¼€æ—¶æ‰€å¤„é€»è¾‘æµçš„ä½ç½®ã€‚çº¿ç¨‹å’Œè¿›ç¨‹çš„æ“ä½œæ˜¯ç”±ç¨‹åºè§¦å‘ç³»ç»Ÿæ¥å£ï¼Œæœ€åçš„æ‰§è¡Œè€…æ˜¯ç³»ç»Ÿï¼›åç¨‹çš„æ“ä½œæ‰§è¡Œè€…åˆ™æ˜¯ç”¨æˆ·è‡ªèº«ç¨‹åºï¼Œgoroutineä¹Ÿæ˜¯åç¨‹ã€‚</p>

<h4 id="è°ƒåº¦æ¨¡å‹ç®€ä»‹">è°ƒåº¦æ¨¡å‹ç®€ä»‹</h4>

<p>groutineèƒ½æ‹¥æœ‰å¼ºå¤§çš„å¹¶å‘å®ç°æ˜¯é€šè¿‡GPMè°ƒåº¦æ¨¡å‹å®ç°ï¼Œä¸‹é¢å°±æ¥è§£é‡Šä¸‹goroutineçš„è°ƒåº¦æ¨¡å‹ã€‚</p>

<p><img src="/assets/images/2020/2020-01-13-our-cast.jpg" alt="æ¨¡å‹" /></p>

<p>Goçš„è°ƒåº¦å™¨å†…éƒ¨æœ‰å››ä¸ªé‡è¦çš„ç»“æ„ï¼šMï¼ŒPï¼ŒSï¼ŒSchedï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ˆSchedæœªç»™å‡ºï¼‰</p>

<blockquote>
  <p>Mä»£è¡¨ç³»ç»Ÿçº¿ç¨‹ï¼ŒGä»£è¡¨goroutineï¼ŒPä»£è¡¨å¤„ç†å™¨ï¼Œä¸Šä¸‹æ–‡(å¯ç†è§£ä¸ºcontext)ï¼ŒSchedå­˜å‚¨é—²ç½®æœªä½¿ç”¨çš„P</p>
</blockquote>

<ul>
  <li>
    <p>M:Mä»£è¡¨å†…æ ¸çº§çº¿ç¨‹ï¼Œä¸€ä¸ªMå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œgoroutineå°±æ˜¯è·‘åœ¨Mä¹‹ä¸Šçš„ï¼›Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯</p>
  </li>
  <li>
    <p>G:ä»£è¡¨ä¸€ä¸ªgoroutineï¼Œå®ƒæœ‰è‡ªå·±çš„æ ˆï¼Œinstruction pointerå’Œå…¶ä»–ä¿¡æ¯ï¼ˆæ­£åœ¨ç­‰å¾…çš„channelç­‰ç­‰ï¼‰ï¼Œç”¨äºè°ƒåº¦ã€‚</p>
  </li>
  <li>
    <p>P:På…¨ç§°æ˜¯Processorï¼Œå¤„ç†å™¨ï¼Œå®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œgoroutineçš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªgoroutineé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰éœ€è¦å®ƒæ¥æ‰§è¡Œçš„goroutine Schedï¼šä»£è¡¨è°ƒåº¦å™¨ï¼Œå®ƒç»´æŠ¤æœ‰å­˜å‚¨Må’ŒGçš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚</p>
  </li>
</ul>

<p>ä¸ºä»€ä¹ˆè¦Goè°ƒåº¦å™¨ï¼Ÿ</p>

<p>ç”¨æˆ·ç©ºé—´çº¿ç¨‹å’Œå†…æ ¸ç©ºé—´çº¿ç¨‹ä¹‹é—´çš„æ˜ å°„å…³ç³»æœ‰ï¼šN:1,1:1å’ŒM:N</p>

<ul>
  <li>
    <p>N:1æ˜¯è¯´ï¼Œå¤šä¸ªï¼ˆNï¼‰ç”¨æˆ·çº¿ç¨‹å§‹ç»ˆåœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ï¼Œcontextä¸Šä¸‹æ–‡åˆ‡æ¢ç¡®å®å¾ˆå¿«ï¼Œä½†æ˜¯æ— æ³•çœŸæ­£çš„åˆ©ç”¨å¤šæ ¸ã€‚</p>
  </li>
  <li>
    <p>1ï¼š1æ˜¯è¯´ï¼Œä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å°±åªåœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ï¼Œè¿™æ—¶å¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼Œä½†æ˜¯ä¸Šä¸‹æ–‡switchå¾ˆæ…¢ã€‚</p>
  </li>
  <li>
    <p>M:Næ˜¯è¯´ï¼Œ å¤šä¸ªgoroutineåœ¨å¤šä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ï¼Œè¿™ä¸ªçœ‹ä¼¼å¯ä»¥é›†é½ä¸Šé¢ä¸¤è€…çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯æ— ç–‘å¢åŠ äº†è°ƒåº¦çš„éš¾åº¦ã€‚</p>
  </li>
</ul>

<h4 id="è°ƒåº¦å®ç°">è°ƒåº¦å®ç°</h4>

<p><img src="/assets/images/2020/2020-01-13-in-motion.jpg" alt="å®ç°" /></p>

<p>ä»ä¸Šå›¾ä¸­çœ‹ï¼Œæœ‰2ä¸ªç‰©ç†çº¿ç¨‹Mï¼Œæ¯ä¸€ä¸ªMéƒ½æ‹¥æœ‰ä¸€ä¸ªå¤„ç†å™¨Pï¼Œæ¯ä¸€ä¸ªä¹Ÿéƒ½æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineã€‚</p>

<p>Pçš„æ•°é‡å¯ä»¥é€šè¿‡GOMAXPROCS()æ¥è®¾ç½®ï¼Œå®ƒå…¶å®ä¹Ÿå°±ä»£è¡¨äº†çœŸæ­£çš„å¹¶å‘åº¦ï¼Œå³æœ‰å¤šå°‘ä¸ªgoroutineå¯ä»¥åŒæ—¶è¿è¡Œã€‚Pçš„æœ€å¤§ä¸º256ä¸ªï¼Œå³é»˜è®¤æœ€å¤§å¤„ç†å™¨ä¸º256æ ¸</p>

<p>å›¾ä¸­ç°è‰²çš„é‚£äº›goroutineå¹¶æ²¡æœ‰è¿è¡Œï¼Œè€Œæ˜¯å‡ºäºreadyçš„å°±ç»ªæ€ï¼Œæ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚Pç»´æŠ¤ç€è¿™ä¸ªé˜Ÿåˆ—ï¼ˆç§°ä¹‹ä¸ºrunqueueï¼‰</p>

<p>Goè¯­è¨€é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªgoroutineå¾ˆå®¹æ˜“ï¼šgo function å°±è¡Œï¼Œæ‰€ä»¥æ¯æœ‰ä¸€ä¸ªgoè¯­å¥è¢«æ‰§è¡Œï¼Œrunqueueé˜Ÿåˆ—å°±åœ¨å…¶æœ«å°¾åŠ å…¥ä¸€ä¸ª</p>

<p>goroutineï¼Œåœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦ç‚¹ï¼Œå°±ä»runqueueä¸­å–å‡ºï¼ˆå¦‚ä½•å†³å®šå–å“ªä¸ªgoroutineï¼Ÿï¼‰ä¸€ä¸ªgoroutineæ‰§è¡Œã€‚</p>

<p>å½“ä¸€ä¸ªOSçº¿ç¨‹M0é™·å…¥é˜»å¡æ—¶ï¼ˆå¦‚ä¸‹å›¾)ï¼ŒPè½¬è€Œåœ¨è¿è¡ŒM1ï¼Œå›¾ä¸­çš„M1å¯èƒ½æ˜¯æ­£è¢«åˆ›å»ºï¼Œæˆ–è€…ä»çº¿ç¨‹ç¼“å­˜ä¸­å–å‡ºã€‚</p>

<p><img src="/assets/images/2020/2020-01-13-syscall.jpg" alt="é˜»å¡" /></p>

<p>å½“MOè¿”å›æ—¶ï¼Œå®ƒå¿…é¡»å°è¯•å–å¾—ä¸€ä¸ªPæ¥è¿è¡Œgoroutineï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒä¼šä»å…¶ä»–çš„OSçº¿ç¨‹é‚£é‡Œæ‹¿ä¸€ä¸ªPè¿‡æ¥ï¼Œ
å¦‚æœæ²¡æœ‰æ‹¿åˆ°çš„è¯ï¼Œå®ƒå°±æŠŠgoroutineæ”¾åœ¨ä¸€ä¸ªglobal runqueueé‡Œï¼Œç„¶åè‡ªå·±ç¡çœ ï¼ˆæ”¾å…¥çº¿ç¨‹ç¼“å­˜é‡Œï¼‰ã€‚æ‰€æœ‰çš„Pä¹Ÿä¼šå‘¨æœŸæ€§çš„æ£€æŸ¥global runqueueå¹¶è¿è¡Œå…¶ä¸­çš„goroutineï¼Œå¦åˆ™global runqueueä¸Šçš„goroutineæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚   å¦ä¸€ç§æƒ…å†µæ˜¯Pæ‰€åˆ†é…çš„ä»»åŠ¡Gå¾ˆå¿«å°±æ‰§è¡Œå®Œäº†ï¼ˆåˆ†é…ä¸å‡ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†è¿™ä¸ªå¤„ç†å™¨På¾ˆå¿™ï¼Œä½†æ˜¯å…¶ä»–çš„Pè¿˜æœ‰ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚æœglobal runqueueæ²¡æœ‰ä»»åŠ¡Gäº†ï¼Œé‚£ä¹ˆPä¸å¾—ä¸ä»å…¶ä»–çš„Pé‡Œæ‹¿ä¸€äº›Gæ¥æ‰§è¡Œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœPä»å…¶ä»–çš„Pé‚£é‡Œè¦æ‹¿ä»»åŠ¡çš„è¯ï¼Œä¸€èˆ¬å°±æ‹¿run queueçš„ä¸€åŠï¼Œè¿™å°±ç¡®ä¿äº†æ¯ä¸ªOSçº¿ç¨‹éƒ½èƒ½å……åˆ†çš„ä½¿ç”¨ï¼Œå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="/assets/images/2020/2020-01-13-steal.jpg" alt="å›¾4" /></p>

<p>goroutineåœ¨ system call å’Œ channel call å‘ç”Ÿé˜»å¡æ—¶ï¼Œæœ‰ä¸åŒå¤„ç†æ–¹å¼ï¼š</p>

<p>å½“ç¨‹åºå‘èµ·system callæ—¶ï¼ŒMä¼šå‘ç”Ÿé˜»å¡ï¼ŒåŒæ—¶å”¤èµ·(æˆ–åˆ›å»º)ä¸€ä¸ªæ–°çš„Mç»§ç»­æ‰§è¡Œå…¶ä»–çš„G
å½“ç¨‹åºå‘èµ·channel callæ—¶ï¼Œç¨‹åºå¯èƒ½ä¼šå‘ç”Ÿé˜»å¡ï¼Œä½†æ˜¯ä¸ä¼šé˜»å¡Mï¼ŒGçš„çŠ¶æ€ä¼šè®¾ç½®ä¸ºwaitingï¼ŒMç»§ç»­æ‰§è¡Œå…¶ä»–çš„Gã€‚å½“Gè°ƒç”¨å®Œæˆï¼Œä¼šæœ‰ä¸€ä¸ªå¯ç”¨çš„Mç»§ç»­æ‰§è¡Œå®ƒ</p>

<h3 id="ä½¿ç”¨goroutine">ä½¿ç”¨goroutine</h3>

<h4 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h4>

<p>è®¾ç½®goroutineè¿è¡Œçš„CPUæ•°é‡ï¼Œæœ€æ–°ç‰ˆæœ¬çš„goå·²ç»é»˜è®¤å·²ç»è®¾ç½®äº†ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">num</span> <span class="o">:=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">NumCPU</span><span class="p">()</span>    <span class="c">//è·å–ä¸»æœºçš„é€»è¾‘CPUä¸ªæ•°</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>    <span class="c">//è®¾ç½®å¯åŒæ—¶æ‰§è¡Œçš„æœ€å¤§CPUæ•°</span>
</code></pre></div></div>

<p>ä½¿ç”¨ç¤ºä¾‹</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">cal</span><span class="p">(</span><span class="n">a</span> <span class="kt">int</span> <span class="p">,</span> <span class="n">b</span> <span class="kt">int</span> <span class="p">)</span>  <span class="p">{</span>
    <span class="n">c</span> <span class="o">:=</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d + %d = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
<span class="err">ã€€ã€€</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span><span class="m">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="m">10</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="k">go</span> <span class="n">cal</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="m">1</span><span class="p">)</span>  <span class="c">//å¯åŠ¨10ä¸ªgoroutine æ¥è®¡ç®—</span>
    <span class="p">}</span>
    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span> <span class="o">*</span> <span class="m">2</span><span class="p">)</span> <span class="c">// sleepä½œç”¨æ˜¯ä¸ºäº†ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ç»“æœ
//8 + 9 = 17
//9 + 10 = 19
//4 + 5 = 9
//5 + 6 = 11
//0 + 1 = 1
//1 + 2 = 3
//2 + 3 = 5
//3 + 4 = 7
//7 + 8 = 15
//6 + 7 = 13
</code></pre></div></div>

<h4 id="goroutineå¼‚å¸¸æ•æ‰">goroutineå¼‚å¸¸æ•æ‰</h4>

<p>å½“å¯åŠ¨å¤šä¸ªgoroutineæ—¶ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªgoroutineå¼‚å¸¸äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œé‚£ä¹ˆæ•´ä¸ªç¨‹åºéƒ½ä¼šç»ˆæ­¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºæ—¶å€™æœ€å¥½æ¯ä¸ªgoroutineæ‰€è¿è¡Œçš„å‡½æ•°éƒ½åšå¼‚å¸¸å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†é‡‡ç”¨recover</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">addele</span><span class="p">(</span><span class="n">a</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">,</span><span class="n">i</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>    <span class="c">//åŒ¿åå‡½æ•°æ•è·é”™è¯¯</span>
        <span class="n">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"add ele fail"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
   <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">i</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Arry</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="m">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span><span class="m">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="m">10</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="k">go</span> <span class="n">addele</span><span class="p">(</span><span class="n">Arry</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span> <span class="o">*</span> <span class="m">2</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ç»“æœ
add ele fail
[0 0 0 0]
[0 1 0 0]
[0 1 2 0]
[0 1 2 3]
add ele fail
add ele fail
add ele fail
add ele fail
add ele fail
</code></pre></div></div>

<h4 id="åŒæ­¥çš„goroutine">åŒæ­¥çš„goroutine</h4>

<p>ç”±äºgoroutineæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œé‚£å¾ˆæœ‰å¯èƒ½å‡ºç°ä¸»ç¨‹åºé€€å‡ºæ—¶è¿˜æœ‰goroutineæ²¡æœ‰æ‰§è¡Œå®Œï¼Œæ­¤æ—¶goroutineä¹Ÿä¼šè·Ÿç€é€€å‡ºã€‚æ­¤æ—¶å¦‚æœæƒ³ç­‰åˆ°æ‰€æœ‰goroutineä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰é€€å‡ºï¼Œgoæä¾›äº†syncåŒ…å’Œchannelæ¥è§£å†³åŒæ­¥é—®é¢˜ï¼Œå½“ç„¶å¦‚æœä½ èƒ½é¢„æµ‹æ¯ä¸ªgoroutineæ‰§è¡Œçš„æ—¶é—´ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡time.Sleepæ–¹å¼ç­‰å¾…æ‰€æœ‰çš„groutineæ‰§è¡Œå®Œæˆä»¥ååœ¨é€€å‡ºç¨‹åº(å¦‚ä¸Šé¢çš„åˆ—å­)ã€‚</p>

<p>ç¤ºä¾‹ä¸€ï¼šä½¿ç”¨syncåŒ…åŒæ­¥goroutine syncå¤§è‡´å®ç°æ–¹å¼ WaitGroup ç­‰å¾…ä¸€ç»„goroutinueæ‰§è¡Œå®Œæ¯•. ä¸»ç¨‹åºè°ƒç”¨ Add æ·»åŠ ç­‰å¾…çš„goroutinueæ•°é‡. æ¯ä¸ªgoroutinueåœ¨æ‰§è¡Œç»“æŸæ—¶è°ƒç”¨ Done ï¼Œæ­¤æ—¶ç­‰å¾…é˜Ÿåˆ—æ•°é‡å‡1.ï¼Œä¸»ç¨‹åºé€šè¿‡Waité˜»å¡ï¼Œç›´åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸º0.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"sync"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">cal</span><span class="p">(</span><span class="n">a</span> <span class="kt">int</span> <span class="p">,</span> <span class="n">b</span> <span class="kt">int</span> <span class="p">,</span><span class="n">n</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">)</span>  <span class="p">{</span>
    <span class="n">c</span> <span class="o">:=</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d + %d = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="k">defer</span> <span class="n">n</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span> <span class="c">//goroutinueå®Œæˆå, WaitGroupçš„è®¡æ•°-1</span>

<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">go_sync</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span> <span class="c">//å£°æ˜ä¸€ä¸ªWaitGroupå˜é‡</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span><span class="m">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="m">10</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="n">go_sync</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="c">// WaitGroupçš„è®¡æ•°åŠ 1</span>
        <span class="k">go</span> <span class="n">cal</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="m">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">go_sync</span><span class="p">)</span>  
    <span class="p">}</span>
    <span class="n">go_sync</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>  <span class="c">//ç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ç»“æœ
9 + 10 = 19
2 + 3 = 5
3 + 4 = 7
4 + 5 = 9
5 + 6 = 11
1 + 2 = 3
6 + 7 = 13
7 + 8 = 15
0 + 1 = 1
8 + 9 = 17
</code></pre></div></div>

<p>ç¤ºä¾‹äºŒï¼šé€šè¿‡channelå®ç°goroutineä¹‹é—´çš„åŒæ­¥ã€‚</p>

<p>å®ç°æ–¹å¼ï¼šé€šè¿‡channelèƒ½åœ¨å¤šä¸ªgroutineä¹‹é—´é€šè®¯ï¼Œå½“ä¸€ä¸ªgoroutineå®Œæˆæ—¶å€™å‘channelå‘é€é€€å‡ºä¿¡å·,ç­‰æ‰€æœ‰goroutineé€€å‡ºæ—¶å€™ï¼Œåˆ©ç”¨forå¾ªç¯channeå»channelä¸­çš„ä¿¡å·ï¼Œè‹¥å–ä¸åˆ°æ•°æ®ä¼šé˜»å¡åŸç†ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œä½¿ç”¨è¯¥æ–¹æ³•æœ‰ä¸ªå‰ææ˜¯ä½ å·²ç»çŸ¥é“äº†ä½ å¯åŠ¨äº†å¤šå°‘ä¸ªgoroutineã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">cal</span><span class="p">(</span><span class="n">a</span> <span class="kt">int</span> <span class="p">,</span> <span class="n">b</span> <span class="kt">int</span> <span class="p">,</span><span class="n">Exitchan</span> <span class="k">chan</span> <span class="kt">bool</span><span class="p">)</span>  <span class="p">{</span>
    <span class="n">c</span> <span class="o">:=</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d + %d = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="m">2</span><span class="p">)</span>
    <span class="n">Exitchan</span> <span class="o">&lt;-</span> <span class="no">true</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">Exitchan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">bool</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>  <span class="c">//å£°æ˜å¹¶åˆ†é…ç®¡é“å†…å­˜</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span><span class="m">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="m">10</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="k">go</span> <span class="n">cal</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="m">1</span><span class="p">,</span><span class="n">Exitchan</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span><span class="m">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="m">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">{</span>
         <span class="o">&lt;-</span> <span class="n">Exitchan</span>  <span class="c">//å–ä¿¡å·æ•°æ®ï¼Œå¦‚æœå–ä¸åˆ°åˆ™ä¼šé˜»å¡</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">Exitchan</span><span class="p">)</span> <span class="c">// å…³é—­ç®¡é“</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="goroutineä¹‹é—´çš„é€šè®¯">goroutineä¹‹é—´çš„é€šè®¯</h4>

<p>goroutineæœ¬è´¨ä¸Šæ˜¯åç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºä¸å—å†…æ ¸è°ƒåº¦ï¼Œè€Œå—goè°ƒåº¦å™¨ç®¡ç†çš„çº¿ç¨‹ã€‚goroutineä¹‹é—´å¯ä»¥é€šè¿‡channelè¿›è¡Œé€šä¿¡æˆ–è€…è¯´æ˜¯æ•°æ®å…±äº«ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡æ¥è¿›è¡Œæ•°æ®å…±äº«ã€‚</p>

<p>ç¤ºä¾‹ï¼šä½¿ç”¨channelæ¨¡æ‹Ÿæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…æ¨¡å¼</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"sync"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">Productor</span><span class="p">(</span><span class="n">mychan</span> <span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="n">data</span> <span class="kt">int</span><span class="p">,</span><span class="n">wait</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">)</span>  <span class="p">{</span>
    <span class="n">mychan</span> <span class="o">&lt;-</span> <span class="n">data</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"product dataï¼š"</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">wait</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">mychan</span> <span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="n">wait</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">)</span>  <span class="p">{</span>
     <span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="n">mychan</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"consumer dataï¼š"</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
     <span class="n">wait</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">datachan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>   <span class="c">//é€šè®¯æ•°æ®ç®¡é“</span>
    <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>

    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="n">Productor</span><span class="p">(</span><span class="n">datachan</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wg</span><span class="p">)</span> <span class="c">//ç”Ÿäº§æ•°æ®</span>
        <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">datachan</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wg</span><span class="p">)</span>  <span class="c">//æ¶ˆè´¹æ•°æ®</span>
        <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ç»“æœ
consumer dataï¼š 4
product dataï¼š 5
product dataï¼š 6
product dataï¼š 7
product dataï¼š 8
product dataï¼š 9
consumer dataï¼š 1
consumer dataï¼š 5
consumer dataï¼š 6
consumer dataï¼š 7
consumer dataï¼š 8
consumer dataï¼š 9
product dataï¼š 2
consumer dataï¼š 2
product dataï¼š 3
consumer dataï¼š 3
product dataï¼š 4
consumer dataï¼š 0
product dataï¼š 0
product dataï¼š 1
</code></pre></div></div>

<h3 id="channel">channel</h3>

<h4 id="ç®€ä»‹">ç®€ä»‹</h4>

<p>channelä¿—ç§°ç®¡é“ï¼Œç”¨äºæ•°æ®ä¼ é€’æˆ–æ•°æ®å…±äº«ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œä½¿ç”¨goroutine+channelè¿›è¡Œæ•°æ®é€šè®¯ç®€å•é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿçº¿ç¨‹å®‰å…¨ï¼Œå¤šä¸ªgoroutineå¯åŒæ—¶ä¿®æ”¹ä¸€ä¸ªchannelï¼Œä¸éœ€è¦åŠ é”ã€‚</p>

<p>channelå¯åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š</p>

<p>åªè¯»channelï¼šåªèƒ½è¯»channelé‡Œé¢æ•°æ®ï¼Œä¸å¯å†™å…¥</p>

<p>åªå†™channelï¼šåªèƒ½å†™æ•°æ®ï¼Œä¸å¯è¯»</p>

<p>ä¸€èˆ¬channelï¼šå¯è¯»å¯å†™</p>

<h4 id="channelä½¿ç”¨">channelä½¿ç”¨</h4>

<p>å®šä¹‰å’Œå£°æ˜</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">readOnlyChan</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="kt">int</span>            <span class="c">// åªè¯»chan</span>
<span class="k">var</span> <span class="n">writeOnlyChan</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">int</span>           <span class="c">// åªå†™chan</span>
<span class="k">var</span> <span class="n">mychan</span>  <span class="k">chan</span> <span class="kt">int</span>                     <span class="c">//è¯»å†™channel</span>
<span class="c">//å®šä¹‰å®Œæˆä»¥åéœ€è¦makeæ¥åˆ†é…å†…å­˜ç©ºé—´ï¼Œä¸ç„¶ä½¿ç”¨ä¼šdeadlock</span>
<span class="n">mychannel</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>

<span class="c">//æˆ–è€…</span>
<span class="n">read_only</span> <span class="o">:=</span> <span class="nb">make</span> <span class="p">(</span><span class="o">&lt;-</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="m">10</span><span class="p">)</span><span class="c">//å®šä¹‰åªè¯»çš„channel</span>
<span class="n">write_only</span> <span class="o">:=</span> <span class="nb">make</span> <span class="p">(</span><span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">,</span><span class="m">10</span><span class="p">)</span><span class="c">//å®šä¹‰åªå†™çš„channel</span>
<span class="n">read_write</span> <span class="o">:=</span> <span class="nb">make</span> <span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="m">10</span><span class="p">)</span><span class="c">//å¯åŒæ—¶è¯»å†™</span>
</code></pre></div></div>

<p>è¯»å†™æ•°æ®</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>

<ul>
  <li>ç®¡é“å¦‚æœæœªå…³é—­ï¼Œåœ¨è¯»å–è¶…æ—¶ä¼šåˆ™ä¼šå¼•å‘deadlockå¼‚å¸¸</li>
  <li>ç®¡é“å¦‚æœå…³é—­è¿›è¡Œå†™å…¥æ•°æ®ä¼špannic</li>
  <li>å½“ç®¡é“ä¸­æ²¡æœ‰æ•°æ®æ—¶å€™å†è¡Œè¯»å–æˆ–è¯»å–åˆ°é»˜è®¤å€¼ï¼Œå¦‚intç±»å‹é»˜è®¤å€¼æ˜¯0</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ch</span> <span class="o">&lt;-</span> <span class="s">"wd"</span>  <span class="c">//å†™æ•°æ®</span>
<span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="n">ch</span> <span class="c">//è¯»å–æ•°æ®</span>
<span class="n">a</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ch</span>  <span class="c">//ä¼˜é›…çš„è¯»å–æ•°æ®</span>
</code></pre></div></div>

<p>å¾ªç¯ç®¡é“</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>

<ul>
  <li>ä½¿ç”¨rangeå¾ªç¯ç®¡é“ï¼Œå¦‚æœç®¡é“æœªå…³é—­ä¼šå¼•å‘deadlocké”™è¯¯ã€‚</li>
  <li>å¦‚æœé‡‡ç”¨foræ­»å¾ªç¯å·²ç»å…³é—­çš„ç®¡é“ï¼Œå½“ç®¡é“æ²¡æœ‰æ•°æ®æ—¶å€™ï¼Œè¯»å–çš„æ•°æ®ä¼šæ˜¯ç®¡é“çš„é»˜è®¤å€¼ï¼Œå¹¶ä¸”å¾ªç¯ä¸ä¼šé€€å‡ºã€‚</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"time"</span>
<span class="p">)</span>


<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">mychannel</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="n">mychannel</span> <span class="o">&lt;-</span> <span class="n">i</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">mychannel</span><span class="p">)</span>  <span class="c">//å…³é—­ç®¡é“</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"data lenght: "</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mychannel</span><span class="p">))</span>
    <span class="k">for</span>  <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">mychannel</span> <span class="p">{</span>  <span class="c">//å¾ªç¯ç®¡é“</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"data lenght:  %d"</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mychannel</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å¸¦ç¼“å†²åŒºchanneå’Œä¸å¸¦ç¼“å†²åŒºchannel">å¸¦ç¼“å†²åŒºchanneå’Œä¸å¸¦ç¼“å†²åŒºchannel</h4>

<p>å¸¦ç¼“å†²åŒºchannelï¼šå®šä¹‰å£°æ˜æ—¶å€™åˆ¶å®šäº†ç¼“å†²åŒºå¤§å°(é•¿åº¦)ï¼Œå¯ä»¥ä¿å­˜å¤šä¸ªæ•°æ®ã€‚</p>

<p>ä¸å¸¦ç¼“å†²åŒºchannelï¼šåªèƒ½å­˜ä¸€ä¸ªæ•°æ®ï¼Œå¹¶ä¸”åªæœ‰å½“è¯¥æ•°æ®è¢«å–å‡ºæ—¶å€™æ‰èƒ½å­˜ä¸‹ä¸€ä¸ªæ•°æ®ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="c">//ä¸å¸¦ç¼“å†²åŒº</span>
<span class="n">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span> <span class="p">,</span><span class="m">10</span><span class="p">)</span> <span class="c">//å¸¦ç¼“å†²åŒº</span>
</code></pre></div></div>

<p>ä¸å¸¦ç¼“å†²åŒºç¤ºä¾‹ï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">test</span><span class="p">(</span><span class="n">c</span> <span class="k">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"send "</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">&lt;-</span> <span class="n">i</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="n">test</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"get "</span><span class="p">,</span> <span class="o">&lt;-</span><span class="n">ch</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ç»“æœï¼š
send  0
send  1
get  0
get  1
send  2
send  3
get  2
get  3
send  4
send  5
get  4
get  5
send  6
send  7
get  6
get  7
send  8
send  9
get  8
get  9
</code></pre></div></div>

<h4 id="channelå®ç°ä½œä¸šæ± ">channelå®ç°ä½œä¸šæ± </h4>

<p>æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªchannelï¼Œä¸€ä¸ªchannelç”¨äºæ¥å—ä»»åŠ¡ï¼Œä¸€ä¸ªchannelç”¨äºä¿æŒç»“æœï¼Œè¿˜æœ‰ä¸ªchannelç”¨äºå†³å®šç¨‹åºé€€å‡ºçš„æ—¶å€™ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">Task</span><span class="p">(</span><span class="n">taskch</span><span class="p">,</span> <span class="n">resch</span> <span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="n">exitch</span> <span class="k">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>   <span class="c">//å¼‚å¸¸å¤„ç†</span>
        <span class="n">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"do task errorï¼š"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">for</span> <span class="n">t</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">taskch</span> <span class="p">{</span> <span class="c">//  å¤„ç†ä»»åŠ¡</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"do task :"</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">resch</span> <span class="o">&lt;-</span> <span class="n">t</span> <span class="c">//</span>
    <span class="p">}</span>
    <span class="n">exitch</span> <span class="o">&lt;-</span> <span class="no">true</span> <span class="c">//å¤„ç†å®Œå‘é€é€€å‡ºä¿¡å·</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">taskch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="m">20</span><span class="p">)</span> <span class="c">//ä»»åŠ¡ç®¡é“</span>
    <span class="n">resch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="m">20</span><span class="p">)</span>  <span class="c">//ç»“æœç®¡é“</span>
    <span class="n">exitch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span> <span class="c">//é€€å‡ºç®¡é“</span>
    <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="n">taskch</span> <span class="o">&lt;-</span> <span class="n">i</span>
        <span class="p">}</span>
        <span class="nb">close</span><span class="p">(</span><span class="n">taskch</span><span class="p">)</span>
    <span class="p">}()</span>


    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>  <span class="c">//å¯åŠ¨5ä¸ªgoroutineåšä»»åŠ¡</span>
        <span class="k">go</span> <span class="n">Task</span><span class="p">(</span><span class="n">taskch</span><span class="p">,</span> <span class="n">resch</span><span class="p">,</span> <span class="n">exitch</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="c">//ç­‰5ä¸ªgoroutineç»“æŸ</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="o">&lt;-</span><span class="n">exitch</span>
        <span class="p">}</span>
        <span class="nb">close</span><span class="p">(</span><span class="n">resch</span><span class="p">)</span>  <span class="c">//ä»»åŠ¡å¤„ç†å®Œæˆå…³é—­ç»“æœç®¡é“ï¼Œä¸ç„¶rangeæŠ¥é”™</span>
        <span class="nb">close</span><span class="p">(</span><span class="n">exitch</span><span class="p">)</span>  <span class="c">//å…³é—­é€€å‡ºç®¡é“</span>
    <span class="p">}()</span>

    <span class="k">for</span> <span class="n">res</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">resch</span><span class="p">{</span>  <span class="c">//æ‰“å°ç»“æœ</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"task resï¼š"</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="åªè¯»channelå’Œåªå†™channel">åªè¯»channelå’Œåªå†™channel</h4>

<p>ä¸€èˆ¬å®šä¹‰åªè¯»å’Œåªå†™çš„ç®¡é“æ„ä¹‰ä¸å¤§ï¼Œæ›´å¤šæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨å‚æ•°ä¼ é€’æ—¶å€™æŒ‡æ˜ç®¡é“å¯è¯»è¿˜æ˜¯å¯å†™ï¼Œå³ä½¿å½“å‰ç®¡é“æ˜¯å¯è¯»å†™çš„ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="c">//åªèƒ½å‘chané‡Œå†™æ•°æ®</span>
<span class="k">func</span> <span class="n">send</span><span class="p">(</span><span class="n">c</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">c</span> <span class="o">&lt;-</span> <span class="n">i</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c">//åªèƒ½å–channelä¸­çš„æ•°æ®</span>
<span class="k">func</span> <span class="n">get</span><span class="p">(</span><span class="n">c</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">c</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="n">send</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">go</span> <span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ç»“æœ
0
1
2
3
4
5
6
7
8
9
</code></pre></div></div>

<h4 id="select-caseå®ç°éé˜»å¡channel">select-caseå®ç°éé˜»å¡channel</h4>

<p>åŸç†é€šè¿‡select+caseåŠ å…¥ä¸€ç»„ç®¡é“ï¼Œå½“æ»¡è¶³ï¼ˆè¿™é‡Œè¯´çš„æ»¡è¶³æ„æ€æ˜¯æœ‰æ•°æ®å¯è¯»æˆ–è€…å¯å†™)selectä¸­çš„æŸä¸ªcaseæ—¶å€™ï¼Œé‚£ä¹ˆè¯¥caseè¿”å›ï¼Œè‹¥éƒ½ä¸æ»¡è¶³caseï¼Œåˆ™èµ°defaultåˆ†æ”¯ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">send</span><span class="p">(</span><span class="n">c</span> <span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span><span class="m">1</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="m">10</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span>  <span class="p">{</span>
     <span class="n">c</span> <span class="o">&lt;-</span><span class="n">i</span>
     <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"send data : "</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span><span class="m">20</span><span class="p">)</span>
    <span class="n">strch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">string</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>
    <span class="k">go</span> <span class="n">send</span><span class="p">(</span><span class="n">resch</span><span class="p">)</span>
    <span class="n">strch</span> <span class="o">&lt;-</span> <span class="s">"wd"</span>
    <span class="k">select</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">resch</span><span class="o">:</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"get data : "</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">b</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">strch</span><span class="o">:</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"get data : "</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"no channel actvie"</span><span class="p">)</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="c">//ç»“æœï¼šget data :  wd</span>
</code></pre></div></div>

<h4 id="channelé¢‘ç‡æ§åˆ¶">channelé¢‘ç‡æ§åˆ¶</h4>

<p>åœ¨å¯¹channelè¿›è¡Œè¯»å†™çš„æ—¶ï¼Œgoè¿˜æä¾›äº†éå¸¸äººæ€§åŒ–çš„æ“ä½œï¼Œé‚£å°±æ˜¯å¯¹è¯»å†™çš„é¢‘ç‡æ§åˆ¶ï¼Œé€šè¿‡time.Tickeå®ç°</p>

<p>ç¤ºä¾‹ï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"time"</span>
    <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">requests</span><span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span> <span class="p">,</span><span class="m">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="m">5</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="n">requests</span><span class="o">&lt;-</span><span class="n">i</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
    <span class="n">limiter</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Tick</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="m">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">req</span><span class="o">:=</span><span class="k">range</span> <span class="n">requests</span><span class="p">{</span>
        <span class="o">&lt;-</span><span class="n">limiter</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"requets"</span><span class="p">,</span><span class="n">req</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span> <span class="c">//æ‰§è¡Œåˆ°è¿™é‡Œï¼Œéœ€è¦éš”1ç§’æ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œtime.Tick(timer)ä¸Šé¢å·²å®šä¹‰</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c">//ç»“æœï¼š</span>
<span class="c">// requets 1 2018-07-06 10:17:35.98056403 +0800 CST m=+1.004248763</span>
<span class="c">// requets 2 2018-07-06 10:17:36.978123472 +0800 CST m=+2.001798205</span>
<span class="c">// requets 3 2018-07-06 10:17:37.980869517 +0800 CST m=+3.004544250</span>
<span class="c">// requets 4 2018-07-06 10:17:38.976868836 +0800 CST m=+4.000533569</span>
</code></pre></div></div>

<h3 id="å¼•ç”¨">å¼•ç”¨</h3>

<ul>
  <li>[1] <a href="https://www.zhihu.com/question/20862617/answer/27964865">çŸ¥ä¹Yi Wangçš„å›ç­”</a></li>
  <li>[2] <a href="https://zhuanlan.zhihu.com/p/22297799">Goroutine æµ…æ</a></li>
</ul>
:ET