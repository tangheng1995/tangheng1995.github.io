I"Ö8<ul id="markdown-toc">
  <li><a href="#ä»‹ç»" id="markdown-toc-ä»‹ç»">ä»‹ç»</a></li>
  <li><a href="#ubuntuä¸‹ä½¿ç”¨docker-swarm-åˆ›å»ºé›†ç¾¤" id="markdown-toc-ubuntuä¸‹ä½¿ç”¨docker-swarm-åˆ›å»ºé›†ç¾¤">Ubuntuä¸‹ä½¿ç”¨docker swarm åˆ›å»ºé›†ç¾¤</a>    <ul>
      <li><a href="#åˆ›å»ºé›†ç¾¤" id="markdown-toc-åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤</a></li>
      <li><a href="#æ·»åŠ èŠ‚ç‚¹" id="markdown-toc-æ·»åŠ èŠ‚ç‚¹">æ·»åŠ èŠ‚ç‚¹</a></li>
      <li><a href="#åˆ›å»ºæœåŠ¡" id="markdown-toc-åˆ›å»ºæœåŠ¡">åˆ›å»ºæœåŠ¡</a></li>
      <li><a href="#æŸ¥çœ‹æœåŠ¡çŠ¶æ€" id="markdown-toc-æŸ¥çœ‹æœåŠ¡çŠ¶æ€">æŸ¥çœ‹æœåŠ¡çŠ¶æ€</a></li>
      <li><a href="#æœåŠ¡ä¸­ä»»åŠ¡å‰¯æœ¬æ•°" id="markdown-toc-æœåŠ¡ä¸­ä»»åŠ¡å‰¯æœ¬æ•°">æœåŠ¡ä¸­ä»»åŠ¡å‰¯æœ¬æ•°</a></li>
      <li><a href="#åˆ é™¤æœåŠ¡" id="markdown-toc-åˆ é™¤æœåŠ¡">åˆ é™¤æœåŠ¡</a></li>
      <li><a href="#æ»šåŠ¨æ›´æ–°" id="markdown-toc-æ»šåŠ¨æ›´æ–°">æ»šåŠ¨æ›´æ–°</a></li>
      <li><a href="#drainçŠ¶æ€çš„èŠ‚ç‚¹" id="markdown-toc-drainçŠ¶æ€çš„èŠ‚ç‚¹">DRAINçŠ¶æ€çš„èŠ‚ç‚¹</a></li>
      <li><a href="#å¼•ç”¨" id="markdown-toc-å¼•ç”¨">å¼•ç”¨</a></li>
    </ul>
  </li>
</ul>

<h2 id="ä»‹ç»">ä»‹ç»</h2>

<p>Docker Enginesçš„é›†ç¾¤ç®¡ç†å’Œä¸šåŠ¡æµç¨‹åŠŸèƒ½æ˜¯ç”±swarmkitæ„å»ºçš„ã€‚Swarmkitæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œç”±Dockerç›´æ¥è°ƒç”¨æ¥å®ç°Dockerçš„ä¸šåŠ¡æµç¨‹å±‚ã€‚</p>

<p>Swarmç”±å¤šä¸ªè¿è¡Œäº†swarmæ¨¡å¼Docker Engineçš„å®¿ä¸»æœºç»„æˆï¼Œæ¯ä¸€ä¸ªå®¿ä¸»æœºæ‰®æ¼”äº†managerè§’è‰²æˆ–è€…workerè§’è‰²ï¼Œå†æˆ–è€…å³æ‰®æ¼”äº†managerè§’è‰²ä¹Ÿæ‰®æ¼”äº†workerè§’è‰²ã€‚Manageræ˜¯ç®¡ç†èŠ‚ç‚¹å…³ç³»å’Œå§”æ‰˜çš„èŠ‚ç‚¹ï¼Œè€Œworkeræ˜¯ç”¨æ¥è¿è¡Œserviceçš„èŠ‚ç‚¹ã€‚</p>

<h2 id="ubuntuä¸‹ä½¿ç”¨docker-swarm-åˆ›å»ºé›†ç¾¤">Ubuntuä¸‹ä½¿ç”¨docker swarm åˆ›å»ºé›†ç¾¤</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker-machine</code> å¯åœ¨å•èŠ‚ç‚¹ä¸Šè™šæ‹Ÿå¤šä¸ªèŠ‚ç‚¹åˆ›å»ºé›†ç¾¤(æµ‹è¯•ä½¿ç”¨ï¼Œä¸å»ºè®®ç”Ÿäº§)</li>
  <li><code class="language-plaintext highlighter-rouge">docker swarm init --advertise-addr &lt;MANAGER-IP&gt;</code> åˆ›å»ºé›†ç¾¤</li>
</ul>

<p>æœ¬æ¬¡æµ‹è¯•ä½¿ç”¨å¤šèŠ‚ç‚¹åˆ›å»ºdocker swarm é›†ç¾¤</p>

<h3 id="åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker swarm init <span class="nt">--advertise-addr</span> &lt;MANAGER-IP&gt;
</code></pre></div></div>

<p>MANAGER-IP ä¸ºæˆ‘ä½œä¸ºmanagerèŠ‚ç‚¹çš„IPï¼Œå…¶ä»–workerèŠ‚ç‚¹å¿…é¡»é€šè¿‡è¿™ä¸ªIPè®¿é—®åˆ°è¯¥èŠ‚ç‚¹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker swarm init <span class="nt">--advertise-addr</span> 192.168.17.135
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>brook:
Swarm initialized: current node <span class="o">(</span>ijiiozx9qim84b7ky1k33et30<span class="o">)</span> is now a manager.

To add a worker to this swarm, run the following <span class="nb">command</span>:

    docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMTKN-1-19wv30d5bzg9a5k60n4afvtcrhxbzek3c3zv2241s3pdbuvpzd-9ycrg2o42n3p8l5z8ga1hiz7t 192.168.17.135:2377

To add a manager to this swarm, run <span class="s1">'docker swarm join-token manager'</span> and follow the instructions.
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤å‡­è¯</span>
<span class="nb">sudo </span>docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMTKN-1-19wv30d5bzg9a5k60n4afvtcrhxbzek3c3zv2241s3pdbuvpzd-9ycrg2o42n3p8l5z8ga1hiz7t 192.168.17.135:2377
</code></pre></div></div>

<p>tokenå‡­è¯ä¸ºæ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‡­è¯</p>

<p>æŸ¥çœ‹tokenï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker swarm join-token worker
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker info æŸ¥çœ‹swarmçŠ¶æ€</span>
<span class="nv">$ </span><span class="nb">sudo </span>docker info

Swarm: active
  NodeID: ijiiozx9qim84b7ky1k33et30
  Is Manager: <span class="nb">true
  </span>ClusterID: 04329fak6fjmxqxfmpcc0o0se
  Managers: 1
  Nodes: 1
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker node ls æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯</span>

<span class="nv">$ </span><span class="nb">sudo </span>docker node <span class="nb">ls

</span>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
ijiiozx9qim84b7ky1k33et30 <span class="k">*</span>   swarm               Ready               Active              Leader              19.03.8
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">*</code> è¡¨ç¤ºå½“å‰é“¾æ¥çš„èŠ‚ç‚¹ï¼Œå³æˆ‘ä»¬æ‰§è¡Œæ“ä½œå‘½ä»¤çš„èŠ‚ç‚¹ã€‚</p>

<h3 id="æ·»åŠ èŠ‚ç‚¹">æ·»åŠ èŠ‚ç‚¹</h3>

<p>ä¸»èŠ‚ç‚¹ï¼š192.168.17.135</p>

<p>å­èŠ‚ç‚¹ï¼š</p>

<ul>
  <li>192.168.17.136</li>
  <li>192.168.17.137</li>
</ul>

<p>workerèŠ‚ç‚¹åŠ å…¥swarmé›†ç¾¤</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMTKN-1-19wv30d5bzg9a5k60n4afvtcrhxbzek3c3zv2241s3pdbuvpzd-9ycrg2o42n3p8l5z8ga1hiz7t 192.168.17.135:2377
This node joined a swarm as a worker.
</code></pre></div></div>

<h3 id="åˆ›å»ºæœåŠ¡">åˆ›å»ºæœåŠ¡</h3>

<p>åœ¨managerä¸Šåˆ›å»ºæœåŠ¡</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker service create <span class="nt">--replicas</span> 1 <span class="nt">--name</span> helloworld alpine ping docker.com

s05l117gvfosnct3s7us29l2i
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker service create</code>å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªservice</li>
  <li><code class="language-plaintext highlighter-rouge">--name</code> å°†serviceå‘½åä¸º <code class="language-plaintext highlighter-rouge">helloworld</code></li>
  <li><code class="language-plaintext highlighter-rouge">--replicas</code> æŒ‡å®šè¿è¡Œ1ä¸ªå®ä¾‹</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">alpine ping docker.com</code> å®šä¹‰äº†serviceå°†ä»¥<code class="language-plaintext highlighter-rouge">Alpine Linux</code>ä¸ºé•œåƒçš„containerè¿è¡Œï¼Œå¹¶åœ¨containerå†…éƒ¨æ‰§è¡Œå‘½ä»¤<code class="language-plaintext highlighter-rouge">ping docker.com</code></p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">--publish</code>å‚æ•°æ¥æš´éœ²ç«¯å£ã€‚targetç”¨æ¥æŒ‡å®šcontainerå†…éƒ¨çš„ç«¯å£å·</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker service ls æŸ¥çœ‹æœåŠ¡</span>
<span class="nv">$ </span><span class="nb">sudo </span>docker service <span class="nb">ls
</span>ID            NAME        SCALE  IMAGE   COMMAND
s05l117gvfos  helloworld  1/1    alpine  ping docker.com
</code></pre></div></div>

<h3 id="æŸ¥çœ‹æœåŠ¡çŠ¶æ€">æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h3>

<p>åœ¨managerèŠ‚ç‚¹ä¸Šæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">docker service inspect --pretty &lt;SERVICE-ID&gt;</code> æŸ¥çœ‹serviceçš„è¯¦ç»†ä¿¡æ¯,<code class="language-plaintext highlighter-rouge">docker service inspect &lt;SERVICE-ID&gt;</code> æŸ¥çœ‹jsonæ ¼å¼</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker service inspect <span class="nt">--pretty</span> helloworld

ID:             s05l117gvfosnct3s7us29l2i
Name:           helloworld
Service Mode:   Replicated
 Replicas:      1
Placement:
UpdateConfig:
 Parallelism:   1
 On failure:    pause
 Monitoring Period: 5s
 Max failure ratio: 0
 Update order:      stop-first
RollbackConfig:
 Parallelism:   1
 On failure:    pause
 Monitoring Period: 5s
 Max failure ratio: 0
 Rollback order:    stop-first
ContainerSpec:
 Image:         alpine:latest@sha256:b276d875eeed9c7d3f1cfa7edb06b22ed22b14219a7d67c52c56612330348239
 Args:          ping docker.com
 Init:          <span class="nb">false
</span>Resources:
Endpoint Mode:  vip
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker service ps helloworld</code> æŸ¥çœ‹serviceåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
som7bkgohcv1        helloworld.1        alpine:latest       swarm               Running             Running 10 minutes ago
</code></pre></div></div>

<h3 id="æœåŠ¡ä¸­ä»»åŠ¡å‰¯æœ¬æ•°">æœåŠ¡ä¸­ä»»åŠ¡å‰¯æœ¬æ•°</h3>

<p>é›†ç¾¤åˆ†å¸ƒå¼éƒ¨ç½²æœåŠ¡å¯æŒ‡å®šæœåŠ¡å‰¯æœ¬æ•°ï¼Œåœ¨managerèŠ‚ç‚¹ä¸Šæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">docker service scale &lt;SERVICE-ID&gt;=&lt;NUMBER-OF-TASKS&gt;</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker service scale <span class="nv">helloworld</span><span class="o">=</span>5

helloworld scaled to 5
overall progress: 5 out of 5 tasks
1/5: running
2/5: running
3/5: running
4/5: running
5/5: running
</code></pre></div></div>

<p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker service ps helloworld

ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS
som7bkgohcv1        helloworld.1        alpine:latest       swarm               Running             Running 17 minutes ago
lbznumtbgtx2        helloworld.2        alpine:latest       swarm-worker1       Running             Running about a minute ago
xcu7by8nmb2j        helloworld.3        alpine:latest       swarm-worker2       Running             Running about a minute ago
px3urph3p30s        helloworld.4        alpine:latest       swarm-worker2       Running             Running about a minute ago
924k8gdu234m        helloworld.5        alpine:latest       swarm               Running             Running about a minute ago
</code></pre></div></div>

<h3 id="åˆ é™¤æœåŠ¡">åˆ é™¤æœåŠ¡</h3>

<p>åœ¨managerèŠ‚ç‚¹ä¸Š <code class="language-plaintext highlighter-rouge">docker service rm &lt;SERVICE-ID&gt;</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker service <span class="nb">rm </span>helloworld

helloworld
</code></pre></div></div>

<p>æŸ¥çœ‹æœåŠ¡æ˜¯å¦è¢«åˆ é™¤ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker service inspect helloworld
<span class="o">[]</span>
Status: Error: no such service: helloworld, Code: 1
</code></pre></div></div>

<h3 id="æ»šåŠ¨æ›´æ–°">æ»šåŠ¨æ›´æ–°</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker service create <span class="se">\</span>
   <span class="nt">--replicas</span> 3 <span class="se">\</span>
   <span class="nt">--name</span> redis <span class="se">\</span>
   <span class="nt">--update-delay</span> 10s <span class="se">\</span>
   redis:alpine
</code></pre></div></div>

<p>åœ¨éƒ¨ç½²æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å‡çº§æ“ä½œçš„ç­–ç•¥è¿›è¡Œè®¾ç½®ã€‚</p>

<p>â€“update-delayæŒ‡å®šæ¯ä¸€ä¸ªtaskå‡çº§çš„å»¶æ—¶æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ±‚æ¯ä¸ªtaskè¾ƒä¹‹å‰ä¸€ä¸ªtaskå¼€å§‹å‡çº§çš„æ—¶é—´å»¶æ—¶Tç§’ï¼Œåˆ™æŠŠå‚æ•°è®¾ç½®æˆTsï¼Œsè¡¨ç¤ºå•ä½ç§’ï¼Œmè¡¨ç¤ºå•ä½åˆ†é’Ÿï¼Œhè¡¨ç¤ºå•ä½å°æ—¶ã€‚æ‰€ä»¥10m30sï¼Œè¡¨ç¤ºå°†å»¶æ—¶10åˆ†30ç§’ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹ä¸€æ¬¡æ›´æ–°1ä¸ªtaskï¼Œå¯ä»¥é€šè¿‡å‚æ•°â€“update-parallelismæ¥è®¾ç½®åŒæ—¶å¼€å§‹æ›´æ–°çš„æœ€å¤§taskä¸ªæ•°ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹å½“ä¸€ä¸ªæ‰§è¡Œæ›´æ–°ä»»åŠ¡çš„taskçš„çŠ¶æ€æˆä¸ºRUNNINGæ—¶ï¼Œæ‰ä¼šç»§ç»­å¼€å§‹ä¸‹ä¸€ä¸ªtaskçš„æ›´æ–°ï¼ŒçŸ¥é“æ‰€æœ‰çš„taskéƒ½æˆä¸ºRUNNINGçŠ¶æ€ä¸ºæ­¢ã€‚ä¸€æ—¦æ›´æ–°æ“ä½œè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªtaskè¿”å›FAILEDçŠ¶æ€ï¼Œåˆ™æ›´æ–°ä¼šç«‹å³åœæ­¢ã€‚æˆ‘ä»¬å¯ä»¥åœ¨docker service createæˆ–è€…docker service updateå‘½ä»¤ä¸­ä½¿ç”¨â€“update-failure-actionå‚æ•°ï¼Œæ¥æ§åˆ¶æ›´æ–°å¤±è´¥åçš„æ“ä½œã€‚</p>

<p>manageræ›´æ–°ä»»åŠ¡ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service update <span class="nt">--image</span> redis:alpine3.11   redis

redis
</code></pre></div></div>

<p>è°ƒåº¦æ›´æ–°çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>

<ul>
  <li>åœæ­¢ç¬¬ä¸€ä¸ªtaskã€‚</li>
  <li>æ›´æ–°ç¬¬ä¸€ä¸ªåœæ­¢çš„taskã€‚</li>
  <li>æ›´æ–°å®Œæˆåå°†taskå¯åŠ¨èµ·å•¦ã€‚</li>
  <li>å¦‚æœtaskè¿”å›RUNNINGçŠ¶æ€ï¼Œåœ¨ç­‰å¾…taskæ›´æ–°å»¶æ—¶æ—¶é—´åˆ°è¾¾åï¼Œå¼€å§‹æ›´æ–°ä¸‹ä¸€ä¸ªtaskã€‚</li>
  <li>å¦‚æœtaskè¿”å›FAILED çŠ¶æ€ï¼Œåˆ™åœæ­¢æ›´æ–°æ“ä½œã€‚</li>
</ul>

<h3 id="drainçŠ¶æ€çš„èŠ‚ç‚¹">DRAINçŠ¶æ€çš„èŠ‚ç‚¹</h3>

<p>DRAINçŠ¶æ€å°†é˜»æ­¢èŠ‚ç‚¹æ¥æ”¶manageråˆ†é…çš„ä»»åŠ¡ã€‚åŒæ—¶ä¹Ÿæ„å‘³ç€ï¼Œmanagerå°†åœæ­¢è¯¥èŠ‚ç‚¹ä¸Šçš„taskï¼Œå¹¶å°†taskè½¬ç§»åˆ°å…¶ä»–ACTIVEçŠ¶æ€çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p>

<p><code class="language-plaintext highlighter-rouge">docker node update --availability drain &lt;NODE-ID&gt;</code> å°†èŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸ºDRAIN</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker node update <span class="nt">--availability</span> drain worker1

worker1
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker node update --availability active &lt;NODE-ID&gt;</code>ä½¿èŠ‚ç‚¹çŠ¶æ€å˜å›åˆ°ACTIVE</p>

<h3 id="å¼•ç”¨">å¼•ç”¨</h3>

<ul>
  <li>[1] <a href="https://www.bookstack.cn/read/docker-swarm-guides/swarmmo-shi-guan-jian-gai-nian.md">Swarmæ¨¡å¼å…³é”®æ¦‚å¿µ</a></li>
  <li>[2] <a href="https://yeasy.gitbooks.io/docker_practice/swarm_mode/deploy.html">Swarméƒ¨ç½²æœåŠ¡</a></li>
</ul>
:ET