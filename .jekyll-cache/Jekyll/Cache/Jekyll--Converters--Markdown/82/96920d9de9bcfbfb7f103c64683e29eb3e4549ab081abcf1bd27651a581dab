I"¸[<ul id="markdown-toc">
  <li><a href="#ä»‹ç»" id="markdown-toc-ä»‹ç»">ä»‹ç»</a></li>
  <li><a href="#golang-redisä½¿ç”¨" id="markdown-toc-golang-redisä½¿ç”¨">Golang redisä½¿ç”¨</a>    <ul>
      <li><a href="#å®‰è£…" id="markdown-toc-å®‰è£…">å®‰è£…</a></li>
      <li><a href="#ä½¿ç”¨" id="markdown-toc-ä½¿ç”¨">ä½¿ç”¨</a></li>
      <li><a href="#å¼€å‘è§„èŒƒ" id="markdown-toc-å¼€å‘è§„èŒƒ">å¼€å‘è§„èŒƒ</a>        <ul>
          <li><a href="#é”®å€¼è®¾è®¡" id="markdown-toc-é”®å€¼è®¾è®¡">é”®å€¼è®¾è®¡</a>            <ul>
              <li><a href="#keyåè®¾è®¡" id="markdown-toc-keyåè®¾è®¡">keyåè®¾è®¡</a></li>
              <li><a href="#valueè®¾è®¡" id="markdown-toc-valueè®¾è®¡">valueè®¾è®¡</a></li>
              <li><a href="#æ§åˆ¶keyçš„ç”Ÿå‘½å‘¨æœŸredisä¸æ˜¯åƒåœ¾æ¡¶" id="markdown-toc-æ§åˆ¶keyçš„ç”Ÿå‘½å‘¨æœŸredisä¸æ˜¯åƒåœ¾æ¡¶">æ§åˆ¶keyçš„ç”Ÿå‘½å‘¨æœŸï¼Œredisä¸æ˜¯åƒåœ¾æ¡¶</a></li>
            </ul>
          </li>
          <li><a href="#å‘½ä»¤ä½¿ç”¨" id="markdown-toc-å‘½ä»¤ä½¿ç”¨">å‘½ä»¤ä½¿ç”¨</a>            <ul>
              <li><a href="#onå‘½ä»¤å…³æ³¨nçš„æ•°é‡" id="markdown-toc-onå‘½ä»¤å…³æ³¨nçš„æ•°é‡">O(N)å‘½ä»¤å…³æ³¨Nçš„æ•°é‡</a></li>
              <li><a href="#ç¦ç”¨å‘½ä»¤" id="markdown-toc-ç¦ç”¨å‘½ä»¤">ç¦ç”¨å‘½ä»¤</a></li>
              <li><a href="#åˆç†ä½¿ç”¨select" id="markdown-toc-åˆç†ä½¿ç”¨select">åˆç†ä½¿ç”¨select</a></li>
              <li><a href="#ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡" id="markdown-toc-ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡">ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡</a></li>
              <li><a href="#redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ä¸å»ºè®®è¿‡å¤šä½¿ç”¨" id="markdown-toc-redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ä¸å»ºè®®è¿‡å¤šä½¿ç”¨">Redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨</a></li>
              <li><a href="#redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚" id="markdown-toc-redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚">Redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨Luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚</a></li>
              <li><a href="#å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶è¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨" id="markdown-toc-å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶è¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨">å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶ï¼Œè¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#ç¤ºä¾‹" id="markdown-toc-ç¤ºä¾‹">ç¤ºä¾‹</a></li>
      <li><a href="#å‚è€ƒ" id="markdown-toc-å‚è€ƒ">å‚è€ƒ</a></li>
    </ul>
  </li>
</ul>

<h2 id="ä»‹ç»">ä»‹ç»</h2>

<p>Golang redis ä½¿ç”¨ åŠé˜¿é‡Œrediså¼€å‘è§„èŒƒã€‚</p>

<ul>
  <li>github.com/gomodule/redigo/redis</li>
</ul>

<h2 id="golang-redisä½¿ç”¨">Golang redisä½¿ç”¨</h2>

<p>ä½¿ç”¨ gomodule/redigo/redis åº“å¤„ç†redisæ•°æ®åº“ç›¸å…³æ“ä½œã€‚</p>

<h3 id="å®‰è£…">å®‰è£…</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go get github.com/gomodule/redigo/redis
</code></pre></div></div>

<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">cache</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/gomodule/redigo/redis"</span>
<span class="p">)</span>

<span class="c">// Pool redis conn pool</span>
<span class="k">var</span> <span class="n">Pool</span> <span class="o">*</span><span class="n">redis</span><span class="o">.</span><span class="n">Pool</span>

<span class="c">// Redis ç»“æ„ä½“</span>
<span class="k">type</span> <span class="n">Redis</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Conn</span> <span class="n">redis</span><span class="o">.</span><span class="n">Conn</span>
<span class="p">}</span>

<span class="c">// InitPool åˆå§‹åŒ–redis conn pool</span>
<span class="k">func</span> <span class="n">InitPool</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">redis</span><span class="o">.</span><span class="n">Pool</span><span class="p">{</span>
		<span class="n">MaxActive</span><span class="o">:</span>   <span class="m">500</span><span class="p">,</span>
		<span class="n">MaxIdle</span><span class="o">:</span>     <span class="m">3</span><span class="p">,</span>
		<span class="n">IdleTimeout</span><span class="o">:</span> <span class="m">240</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">Dial</span><span class="o">:</span>        <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">redis</span><span class="o">.</span><span class="n">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="s">"127.0.0.1:6379"</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">}</span>
    <span class="n">Pool</span> <span class="o">=</span> <span class="n">pool</span>
    <span class="n">RedisConn</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span>
<span class="p">}</span>

<span class="c">// GetRedisConn get redis conn</span>
<span class="k">func</span> <span class="n">GetRedisConn</span><span class="p">()</span> <span class="n">redis</span><span class="o">.</span><span class="n">Conn</span><span class="p">{</span> 
	<span class="n">conn</span> <span class="o">=</span> <span class="n">Pool</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">Redis</span><span class="p">{</span><span class="n">Conn</span><span class="o">:</span> <span class="n">conn</span><span class="p">}</span>
<span class="p">}</span>

<span class="c">// AddStudentCourse æ·»åŠ å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Redis</span><span class="p">)</span><span class="n">AddStudentCourse</span><span class="p">(</span><span class="n">stdID</span> <span class="kt">int</span><span class="p">,</span> <span class="n">cIDs</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">){</span>
	<span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cID</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">cIDs</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="s">"SADD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">StudentCourseFormat</span><span class="p">,</span> <span class="n">stdID</span><span class="p">),</span><span class="n">cID</span><span class="p">)</span>
		<span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="s">"SADD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">CourseStudentFormat</span><span class="p">,</span> <span class="n">cID</span><span class="p">),</span><span class="n">stdID</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span>
<span class="p">}</span>

<span class="c">// GetStudentCourseCount å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹æ•°</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Redis</span><span class="p">)</span><span class="n">GetStudentCourseCount</span><span class="p">(</span><span class="n">stdID</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">courseCount</span> <span class="kt">int</span><span class="p">){</span>
	<span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 
	<span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="s">"SCARD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">StudentCourseFormat</span><span class="p">,</span> <span class="n">stdID</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¼€å‘è§„èŒƒ">å¼€å‘è§„èŒƒ</h3>

<h4 id="é”®å€¼è®¾è®¡">é”®å€¼è®¾è®¡</h4>

<h5 id="keyåè®¾è®¡">keyåè®¾è®¡</h5>

<ul>
  <li>å¯è¯»æ€§å’Œå¯ç®¡ç†æ€§</li>
</ul>

<p>ä»¥ä¸šåŠ¡å(æˆ–æ•°æ®åº“å)ä¸ºå‰ç¼€(é˜²æ­¢keyå†²çª)ï¼Œç”¨å†’å·åˆ†éš”ï¼Œæ¯”å¦‚ä¸šåŠ¡å:è¡¨å:id</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ugc:video:1
</code></pre></div></div>

<ul>
  <li>ç®€æ´æ€§</li>
</ul>

<p>ä¿è¯è¯­ä¹‰çš„å‰æä¸‹ï¼Œæ§åˆ¶keyçš„é•¿åº¦ï¼Œå½“keyè¾ƒå¤šæ—¶ï¼Œå†…å­˜å ç”¨ä¹Ÿä¸å®¹å¿½è§†ï¼Œä¾‹å¦‚ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user:{uid}:friends:messages:{mid}

# ç®€åŒ–
u:{uid}:fr:m:{mid}
</code></pre></div></div>

<ul>
  <li>ä¸è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦</li>
</ul>

<p>åä¾‹ï¼šåŒ…å«ç©ºæ ¼ã€æ¢è¡Œã€å•åŒå¼•å·ä»¥åŠå…¶ä»–è½¬ä¹‰å­—ç¬¦</p>

<h5 id="valueè®¾è®¡">valueè®¾è®¡</h5>

<ul>
  <li>æ‹’ç»bigkey(é˜²æ­¢ç½‘å¡æµé‡ã€æ…¢æŸ¥è¯¢)</li>
</ul>

<p>stringç±»å‹æ§åˆ¶åœ¨10KBä»¥å†…ï¼Œhashã€listã€setã€zsetå…ƒç´ ä¸ªæ•°ä¸è¦è¶…è¿‡5000ã€‚</p>

<p>åä¾‹ï¼šä¸€ä¸ªåŒ…å«200ä¸‡ä¸ªå…ƒç´ çš„listã€‚</p>

<p>éå­—ç¬¦ä¸²çš„bigkeyï¼Œä¸è¦ä½¿ç”¨delåˆ é™¤ï¼Œä½¿ç”¨hscanã€sscanã€zscanæ–¹å¼æ¸è¿›å¼åˆ é™¤ï¼ŒåŒæ—¶è¦æ³¨æ„é˜²æ­¢bigkeyè¿‡æœŸæ—¶é—´è‡ªåŠ¨åˆ é™¤é—®é¢˜(ä¾‹å¦‚ä¸€ä¸ª200ä¸‡çš„zsetè®¾ç½®1å°æ—¶è¿‡æœŸï¼Œä¼šè§¦å‘delæ“ä½œï¼Œé€ æˆé˜»å¡ï¼Œè€Œä¸”è¯¥æ“ä½œä¸ä¼šä¸å‡ºç°åœ¨æ…¢æŸ¥è¯¢ä¸­(latencyå¯æŸ¥))</p>

<ul>
  <li>é€‰æ‹©é€‚åˆçš„æ•°æ®ç±»å‹ã€‚</li>
</ul>

<p>ä¾‹å¦‚ï¼šå®ä½“ç±»å‹(è¦åˆç†æ§åˆ¶å’Œä½¿ç”¨æ•°æ®ç»“æ„å†…å­˜ç¼–ç ä¼˜åŒ–é…ç½®,ä¾‹å¦‚ziplistï¼Œä½†ä¹Ÿè¦æ³¨æ„èŠ‚çœå†…å­˜å’Œæ€§èƒ½ä¹‹é—´çš„å¹³è¡¡)</p>

<p>åä¾‹ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set user:1:name tom
set user:1:age 19
set user:1:favor football
</code></pre></div></div>

<p>æ­£ä¾‹:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hmset user:1 name tom age 19 favor football
</code></pre></div></div>

<h5 id="æ§åˆ¶keyçš„ç”Ÿå‘½å‘¨æœŸredisä¸æ˜¯åƒåœ¾æ¡¶">æ§åˆ¶keyçš„ç”Ÿå‘½å‘¨æœŸï¼Œredisä¸æ˜¯åƒåœ¾æ¡¶</h5>

<p>å»ºè®®ä½¿ç”¨expireè®¾ç½®è¿‡æœŸæ—¶é—´(æ¡ä»¶å…è®¸å¯ä»¥æ‰“æ•£è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢é›†ä¸­è¿‡æœŸ)ï¼Œä¸è¿‡æœŸçš„æ•°æ®é‡ç‚¹å…³æ³¨idletimeã€‚</p>

<h4 id="å‘½ä»¤ä½¿ç”¨">å‘½ä»¤ä½¿ç”¨</h4>

<h5 id="onå‘½ä»¤å…³æ³¨nçš„æ•°é‡">O(N)å‘½ä»¤å…³æ³¨Nçš„æ•°é‡</h5>

<p>ä¾‹å¦‚hgetallã€lrangeã€smembersã€zrangeã€sinterç­‰å¹¶éä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡®Nçš„å€¼ã€‚æœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨hscanã€sscanã€zscanä»£æ›¿ã€‚</p>

<h5 id="ç¦ç”¨å‘½ä»¤">ç¦ç”¨å‘½ä»¤</h5>

<p>ç¦æ­¢çº¿ä¸Šä½¿ç”¨keysã€flushallã€flushdbç­‰ï¼Œé€šè¿‡redisçš„renameæœºåˆ¶ç¦æ‰å‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨scançš„æ–¹å¼æ¸è¿›å¼å¤„ç†ã€‚</p>

<h5 id="åˆç†ä½¿ç”¨select">åˆç†ä½¿ç”¨select</h5>

<p>redisçš„å¤šæ•°æ®åº“è¾ƒå¼±ï¼Œä½¿ç”¨æ•°å­—è¿›è¡ŒåŒºåˆ†ï¼Œå¾ˆå¤šå®¢æˆ·ç«¯æ”¯æŒè¾ƒå·®ï¼ŒåŒæ—¶å¤šä¸šåŠ¡ç”¨å¤šæ•°æ®åº“å®é™…è¿˜æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œä¼šæœ‰å¹²æ‰°ã€‚</p>

<h5 id="ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡">ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡</h5>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>åŸç”Ÿå‘½ä»¤ï¼šä¾‹å¦‚mgetã€msetã€‚
éåŸç”Ÿå‘½ä»¤ï¼šå¯ä»¥ä½¿ç”¨pipelineæé«˜æ•ˆç‡ã€‚
</code></pre></div></div>

<p>ä½†è¦æ³¨æ„æ§åˆ¶ä¸€æ¬¡æ‰¹é‡æ“ä½œçš„å…ƒç´ ä¸ªæ•°(ä¾‹å¦‚500ä»¥å†…ï¼Œå®é™…ä¹Ÿå’Œå…ƒç´ å­—èŠ‚æ•°æœ‰å…³)ã€‚</p>

<p>æ³¨æ„ä¸¤è€…ä¸åŒï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. åŸç”Ÿæ˜¯åŸå­æ“ä½œï¼Œpipelineæ˜¯éåŸå­æ“ä½œã€‚
2. pipelineå¯ä»¥æ‰“åŒ…ä¸åŒçš„å‘½ä»¤ï¼ŒåŸç”Ÿåšä¸åˆ°
3. pipelineéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ—¶æ”¯æŒã€‚
</code></pre></div></div>

<h5 id="redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ä¸å»ºè®®è¿‡å¤šä½¿ç”¨">Redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨</h5>

<p>Redisçš„äº‹åŠ¡åŠŸèƒ½è¾ƒå¼±(ä¸æ”¯æŒå›æ»š)ï¼Œè€Œä¸”é›†ç¾¤ç‰ˆæœ¬(è‡ªç ”å’Œå®˜æ–¹)è¦æ±‚ä¸€æ¬¡äº‹åŠ¡æ“ä½œçš„keyå¿…é¡»åœ¨ä¸€ä¸ªslotä¸Š(å¯ä»¥ä½¿ç”¨hashtagåŠŸèƒ½è§£å†³)</p>

<h5 id="redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚">Redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨Luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚</h5>

<ul>
  <li>
    <p>1.æ‰€æœ‰keyéƒ½åº”è¯¥ç”± KEYS æ•°ç»„æ¥ä¼ é€’ï¼Œredis.call/pcall é‡Œé¢è°ƒç”¨çš„rediså‘½ä»¤ï¼Œkeyçš„ä½ç½®ï¼Œå¿…é¡»æ˜¯KEYS array, å¦åˆ™ç›´æ¥è¿”å›errorï¼Œâ€-ERR bad lua script for redis cluster, all the keys that the script uses should be passed using the KEYS arrayâ€</p>
  </li>
  <li>
    <p>2.æ‰€æœ‰keyï¼Œå¿…é¡»åœ¨1ä¸ªslotä¸Šï¼Œå¦åˆ™ç›´æ¥è¿”å›error, â€œ-ERR eval/evalsha command keys must in same slotâ€</p>
  </li>
</ul>

<h5 id="å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶è¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨">å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶ï¼Œè¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨</h5>

<h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/gomodule/redigo/redis"</span>
<span class="p">)</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="c">// StudentCourseFormat å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹æ•°</span>
	<span class="n">StudentCourseFormat</span> <span class="o">=</span> <span class="s">"student:%d:course"</span>
	<span class="c">// CourseStudentFormat è¯¾ç¨‹è¢«é€‰ä¿®çš„å­¦ç”Ÿæ•°</span>
	<span class="n">CourseStudentFormat</span> <span class="o">=</span> <span class="s">"course:%d:student"</span>
<span class="p">)</span>

<span class="c">// Pool redis conn pool</span>
<span class="k">var</span> <span class="n">Pool</span> <span class="o">*</span><span class="n">redis</span><span class="o">.</span><span class="n">Pool</span>

<span class="c">// Redis ç»“æ„ä½“</span>
<span class="k">type</span> <span class="n">Redis</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Conn</span> <span class="n">redis</span><span class="o">.</span><span class="n">Conn</span>
<span class="p">}</span>

<span class="c">// InitRedis init redis</span>
<span class="k">func</span> <span class="n">InitRedis</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">redis</span><span class="o">.</span><span class="n">Pool</span><span class="p">{</span>
		<span class="n">MaxActive</span><span class="o">:</span>   <span class="m">500</span><span class="p">,</span>
		<span class="n">MaxIdle</span><span class="o">:</span>     <span class="m">3</span><span class="p">,</span>
		<span class="n">IdleTimeout</span><span class="o">:</span> <span class="m">240</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">Dial</span><span class="o">:</span>        <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">redis</span><span class="o">.</span><span class="n">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="s">"127.0.0.1:10100"</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">}</span>
	<span class="n">Pool</span> <span class="o">=</span> <span class="n">pool</span>
<span class="p">}</span>

<span class="c">// GetRedisConn get redis conn</span>
<span class="k">func</span> <span class="n">GetRedisConn</span><span class="p">()</span> <span class="n">redis</span><span class="o">.</span><span class="n">Conn</span><span class="p">{</span> 
	<span class="n">conn</span> <span class="o">=</span> <span class="n">Pool</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">Redis</span><span class="p">{</span><span class="n">Conn</span><span class="o">:</span> <span class="n">conn</span><span class="p">}</span>
<span class="p">}</span>

<span class="c">// AddStudentCourse æ·»åŠ å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Redis</span><span class="p">)</span><span class="n">AddStudentCourse</span><span class="p">(</span><span class="n">stdID</span> <span class="kt">int</span><span class="p">,</span> <span class="n">cIDs</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">){</span>
	<span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cID</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">cIDs</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="s">"SADD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">StudentCourseFormat</span><span class="p">,</span> <span class="n">stdID</span><span class="p">),</span><span class="n">cID</span><span class="p">)</span>
		<span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="s">"SADD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">CourseStudentFormat</span><span class="p">,</span> <span class="n">cID</span><span class="p">),</span><span class="n">stdID</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span>
<span class="p">}</span>

<span class="c">// GetStudentCourseCount å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹æ•°</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Redis</span><span class="p">)</span><span class="n">GetStudentCourseCount</span><span class="p">(</span><span class="n">stdID</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">courseCount</span> <span class="kt">int</span><span class="p">){</span>
	<span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 
	<span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="s">"SCARD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">StudentCourseFormat</span><span class="p">,</span> <span class="n">stdID</span><span class="p">)))</span>
<span class="p">}</span>

<span class="c">// GetCourseStudentCount è·å–é€‰ä¿®çš„è¯¾ç¨‹å­¦ç”Ÿæ•°</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Redis</span><span class="p">)</span><span class="n">GetCourseStudentCount</span><span class="p">(</span><span class="n">cID</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">studentCount</span> <span class="kt">int</span><span class="p">){</span>
	<span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 
	<span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="s">"SCARD"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">CourseStudentFormat</span><span class="p">,</span> <span class="n">cID</span><span class="p">)))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">(){</span>
	<span class="n">r</span> <span class="o">:=</span> <span class="n">GetRedisConn</span><span class="p">()</span>
	<span class="n">r</span><span class="o">.</span><span class="n">AddStudentCourse</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">])</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">GetStudentCourseCount</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="å‚è€ƒ">å‚è€ƒ</h3>

<ul>
  <li>[1] <a href="https://developer.aliyun.com/article/531067">é˜¿é‡Œäº‘rediså¼€å‘è§„èŒƒ</a></li>
</ul>
:ET